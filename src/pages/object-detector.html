<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proctoring System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .canvas-wrapper { position: relative; width: 100%; max-width: 640px; margin: 0 auto; transition: border-color 0.3s; }
        video { display: block; width: 100%; height: auto; border-radius: 0.5rem; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .stat-card { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(4px); }
        
        /* Custom Scrollbar for dropdown */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Status Animations */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .status-violation { animation: pulse-red 2s infinite; border-color: #ef4444 !important; }
        .status-secure { border-color: #22c55e !important; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col py-6 px-4">

    <!-- Top Status Bar -->
    <div id="main-status-bar" class="w-full max-w-6xl mx-auto mb-6 p-4 rounded-xl flex items-center justify-between bg-gray-800 border-l-8 border-gray-500 shadow-lg transition-colors duration-300">
        <div>
            <h2 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-1">Session Status</h2>
            <div id="status-text" class="text-2xl font-bold text-gray-200">System Standby</div>
        </div>
        <div id="violation-list" class="text-right text-sm text-red-300 font-mono hidden">
            <!-- Violations injected here -->
        </div>
    </div>

    <!-- Main Content Grid -->
    <main class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Col: Video Feed (Span 2) -->
        <div class="lg:col-span-2">
            <div id="video-container" class="canvas-wrapper rounded-lg overflow-hidden border-4 border-gray-700 bg-black relative aspect-video flex items-center justify-center">
                <!-- Loading Spinner -->
                <div id="loader" class="absolute z-10 flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                    <span class="text-sm font-medium animate-pulse">Initializing Proctor AI...</span>
                </div>

                <!-- Cam & Canvas -->
                <video id="webcam" autoplay playsinline class="hidden"></video>
                <canvas id="output_canvas"></canvas>

                <!-- Start Button (Overlay) -->
                <div id="start-overlay" class="absolute inset-0 z-20 bg-gray-900/90 flex items-center justify-center hidden">
                    <button id="enableWebcamButton" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all shadow-lg transform hover:scale-105 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        START EXAM SESSION
                    </button>
                </div>
            </div>
            
            <!-- Mini Logs -->
            <div class="mt-4 p-3 bg-gray-800 rounded text-xs font-mono text-gray-400 h-24 overflow-y-auto" id="console-log">
                <div>> System Ready. Configure rules on the right.</div>
            </div>
        </div>

        <!-- Right Col: Controls & Rules -->
        <div class="flex flex-col gap-4">
            
            <!-- 1. Exam Rules Config -->
            <div class="stat-card p-5 rounded-lg border border-gray-700 shadow-xl flex-grow">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Exam Allowed Objects</h3>
                </div>

                <!-- Add New Rule -->
                <div class="bg-gray-800/50 p-3 rounded mb-4 border border-gray-600">
                    <label class="text-xs text-gray-400 block mb-1">Allow Object:</label>
                    <div class="flex gap-2 mb-2 relative z-50">
                        <!-- Custom Searchable Select -->
                        <div class="relative flex-grow">
                            <input type="text" id="obj-search" placeholder="Search (e.g. phone)..." 
                                   class="w-full bg-gray-700 text-white text-sm rounded px-2 py-1.5 outline-none border border-gray-600 focus:border-blue-500" 
                                   autocomplete="off">
                            <div id="obj-options" class="absolute left-0 right-0 top-full mt-1 bg-gray-800 border border-gray-600 rounded max-h-48 overflow-y-auto hidden shadow-xl divide-y divide-gray-700">
                                <!-- Options injected by JS -->
                            </div>
                        </div>

                        <input type="number" id="obj-count" value="1" min="0" max="10" class="w-16 bg-gray-700 text-white text-sm rounded px-2 py-1.5 outline-none border border-gray-600 focus:border-blue-500 text-center">
                    </div>
                    <button id="add-rule-btn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-xs font-bold text-white rounded transition-colors uppercase shadow-md">
                        + Add to Whitelist
                    </button>
                </div>

                <!-- Active Rules List -->
                <div class="space-y-2 max-h-60 overflow-y-auto" id="rules-list">
                    <!-- Rule Item Template -->
                    <!-- <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700">
                        <span class="text-sm">Person</span>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono bg-blue-900 text-blue-200 px-1.5 rounded">Max: 1</span>
                            <button class="text-red-400 hover:text-red-300">×</button>
                        </div>
                    </div> -->
                </div>
            </div>

            <!-- 2. Diagnostics (Mini) -->
            <div class="stat-card p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Engine Stats</h3>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <span class="text-gray-400">Latency</span>
                        <div id="inference-val" class="text-lg font-mono text-white">0 ms</div>
                    </div>
                    <div>
                        <span class="text-gray-400">FPS</span>
                        <div id="fps-val" class="text-lg font-mono text-white">0</div>
                    </div>
                    <div class="col-span-2 mt-1">
                        <span class="text-gray-400">Sensitivity: </span>
                        <span id="sens-display" class="text-blue-400 font-bold">50%</span>
                        <input type="range" id="sensitivity" min="20" max="90" value="50" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer mt-1">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Logic -->
    <script type="module">
        import {
            ObjectDetector,
            FilesetResolver
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        // --- DOM Elements ---
        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        const loader = document.getElementById("loader");
        const startOverlay = document.getElementById("start-overlay");
        const enableWebcamButton = document.getElementById("enableWebcamButton");
        const logBox = document.getElementById("console-log");
        
        // Status Elements
        const mainStatusBar = document.getElementById("main-status-bar");
        const statusText = document.getElementById("status-text");
        const violationList = document.getElementById("violation-list");
        const videoContainer = document.getElementById("video-container");

        // Config Elements
        const objSearch = document.getElementById("obj-search"); // Changed from select
        const objOptions = document.getElementById("obj-options"); // New
        const objCount = document.getElementById("obj-count");
        const addRuleBtn = document.getElementById("add-rule-btn");
        const rulesListContainer = document.getElementById("rules-list");
        
        // Stats
        const inferenceVal = document.getElementById("inference-val");
        const fpsVal = document.getElementById("fps-val");
        const sensInput = document.getElementById("sensitivity");
        const sensDisplay = document.getElementById("sens-display");

        // --- State ---
        let objectDetector;
        let runningMode = "VIDEO";
        let lastVideoTime = -1;
        let lastProcessTime = -1;
        let minConfidence = 0.5;

        // COCO Labels (Standard 80 objects)
        const COCO_LABELS = [
            'person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 
            'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 
            'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 
            'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 
            'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 
            'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 
            'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 
            'couch', 'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 
            'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 
            'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'
        ];

        // Allowed Rules: { 'object_name': max_count }
        let allowedRules = {
            'person': 1
        };

        // --- Initialization ---

        // Dropdown Logic
        function renderOptions(filterText = "") {
            objOptions.innerHTML = "";
            const lowerFilter = filterText.toLowerCase();
            const filtered = COCO_LABELS.filter(l => l.includes(lowerFilter)).sort();

            if (filtered.length === 0) {
                const div = document.createElement('div');
                div.className = "px-3 py-2 text-gray-500 text-xs italic";
                div.textContent = "No objects found";
                objOptions.appendChild(div);
                return;
            }

            filtered.forEach(label => {
                const div = document.createElement('div');
                div.className = "px-3 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white cursor-pointer transition-colors";
                div.textContent = label.charAt(0).toUpperCase() + label.slice(1);
                div.onclick = () => {
                    objSearch.value = label; // set plain text
                    objOptions.classList.add('hidden');
                };
                objOptions.appendChild(div);
            });
        }

        // Search Input Listeners
        objSearch.addEventListener('focus', () => {
            renderOptions(objSearch.value);
            objOptions.classList.remove('hidden');
        });

        objSearch.addEventListener('input', (e) => {
            renderOptions(e.target.value);
            objOptions.classList.remove('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!objSearch.contains(e.target) && !objOptions.contains(e.target)) {
                objOptions.classList.add('hidden');
            }
        });

        // Initial Rules Render
        renderRules();

        function log(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            logBox.prepend(div);
        }

        // --- Rules Logic ---

        addRuleBtn.addEventListener('click', () => {
            const label = objSearch.value.toLowerCase().trim();
            const count = parseInt(objCount.value);
            
            if (!label) {
                log("Error: Please select an object.");
                return;
            }

            if (!COCO_LABELS.includes(label)) {
                log(`Error: '${label}' is not a recognized object.`);
                return;
            }

            allowedRules[label] = count;
            renderRules();
            objSearch.value = ""; // Clear input
            log(`Updated rule: Allow ${count} ${label}(s)`);
        });

        function removeRule(label) {
            delete allowedRules[label];
            renderRules();
            log(`Removed rule for ${label}`);
        }

        function renderRules() {
            rulesListContainer.innerHTML = '';
            
            if (Object.keys(allowedRules).length === 0) {
                rulesListContainer.innerHTML = '<div class="text-xs text-gray-500 italic text-center p-2">No allowed objects. Everything detected will be a violation.</div>';
                return;
            }

            for (const [label, count] of Object.entries(allowedRules)) {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700 animate-fade-in";
                div.innerHTML = `
                    <span class="text-sm capitalize text-gray-200">${label}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-mono bg-blue-900 text-blue-200 px-2 py-0.5 rounded border border-blue-800">Max: ${count}</span>
                        <button class="delete-btn text-red-400 hover:text-red-300 font-bold px-1" data-label="${label}">×</button>
                    </div>
                `;
                rulesListContainer.appendChild(div);
            }

            // Attach listeners to new delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => removeRule(e.target.dataset.label));
            });
        }

        // --- AI & Camera Logic ---

        sensInput.addEventListener('input', (e) => {
            minConfidence = e.target.value / 100;
            sensDisplay.textContent = `${e.target.value}%`;
        });

        const initializeObjectDetector = async () => {
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
                );
                
                objectDetector = await ObjectDetector.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float32/1/efficientdet_lite0.tflite`,
                        delegate: "CPU"
                    },
                    scoreThreshold: 0.20,
                    runningMode: runningMode
                });
                
                loader.classList.add("hidden");
                startOverlay.classList.remove("hidden");
                startOverlay.classList.add("flex");
                log("Model initialized.");
            } catch (error) {
                log("Error loading model: " + error);
            }
        };

        initializeObjectDetector();

        enableWebcamButton.addEventListener("click", async () => {
            if (!objectDetector) return;
            startOverlay.classList.add("hidden");
            startOverlay.classList.remove("flex");

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                video.classList.remove("hidden");
                log("Camera started. Proctoring active.");
            } catch (err) {
                log("Camera denied.");
            }
        });

        async function predictWebcam() {
            if (canvasElement.width !== video.videoWidth || canvasElement.height !== video.videoHeight) {
                canvasElement.width = video.videoWidth;
                canvasElement.height = video.videoHeight;
            }

            let startTimeMs = performance.now();

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                
                const detections = objectDetector.detectForVideo(video, startTimeMs);
                
                // 1. Analyze for Violations
                const analysis = analyzeFrame(detections.detections);
                
                // 2. Update Status UI
                updateStatusUI(analysis);
                
                // 3. Draw Frame
                drawFrame(detections.detections, analysis);

                // Stats
                const endTimeMs = performance.now();
                inferenceVal.textContent = `${(endTimeMs - startTimeMs).toFixed(1)} ms`;
                
                if (lastProcessTime !== -1) {
                    const delta = performance.now() - lastProcessTime;
                    fpsVal.textContent = (1000 / delta).toFixed(0);
                }
                lastProcessTime = performance.now();
            }

            window.requestAnimationFrame(predictWebcam);
        }

        // --- Core Proctoring Logic ---

        function analyzeFrame(detections) {
            // Count current occurrences
            const currentCounts = {};
            const violations = [];
            let isClean = true;

            // Filter by confidence first
            const validDetections = detections.filter(d => d.categories[0].score >= minConfidence);

            // Tally
            validDetections.forEach(det => {
                const label = det.categories[0].categoryName.toLowerCase();
                currentCounts[label] = (currentCounts[label] || 0) + 1;
            });

            // Check against Rules
            // 1. Check for unauthorized objects (things detected but not in allowedRules)
            Object.keys(currentCounts).forEach(label => {
                if (!allowedRules.hasOwnProperty(label)) {
                    isClean = false;
                    violations.push(`Unauthorized: ${label}`);
                } else if (currentCounts[label] > allowedRules[label]) {
                    isClean = false;
                    violations.push(`Limit exceeded: ${label} (${currentCounts[label]}/${allowedRules[label]})`);
                }
            });

            return { isClean, violations, currentCounts, validDetections };
        }

        function updateStatusUI({ isClean, violations }) {
            if (isClean) {
                // Green State
                mainStatusBar.className = "w-full max-w-6xl mx-auto mb-6 p-4 rounded-xl flex items-center justify-between bg-green-900/20 border-l-8 border-green-500 shadow-lg transition-colors duration-300";
                statusText.textContent = "Session Secure";
                statusText.className = "text-2xl font-bold text-green-400";
                violationList.classList.add("hidden");
                
                videoContainer.classList.remove("status-violation");
                videoContainer.classList.add("status-secure");
            } else {
                // Red State
                mainStatusBar.className = "w-full max-w-6xl mx-auto mb-6 p-4 rounded-xl flex items-center justify-between bg-red-900/20 border-l-8 border-red-500 shadow-lg transition-colors duration-300";
                statusText.textContent = "Violation Detected";
                statusText.className = "text-2xl font-bold text-red-400";
                
                violationList.innerHTML = violations.map(v => `<div>⚠ ${v}</div>`).join('');
                violationList.classList.remove("hidden");

                videoContainer.classList.remove("status-secure");
                videoContainer.classList.add("status-violation");
            }
        }

        function drawFrame(rawDetections, { isClean, violations, currentCounts }) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // Only draw detections that meet confidence
            for (const detection of rawDetections) {
                const score = parseFloat(detection.categories[0].score);
                if (score < minConfidence) continue;

                const label = detection.categories[0].categoryName.toLowerCase();
                
                // Determine if this specific object is a violation
                // It is a violation if:
                // 1. It's not in allowed list OR
                // 2. It IS in allowed list, but we have already counted more than allowed
                
                // Note: This drawing logic is simplified. It draws all objects of a type as RED if the count exceeds the limit.
                // It doesn't distinguish "which" person is the 2nd person, it just flags the type.
                
                let isViolation = false;
                if (!allowedRules.hasOwnProperty(label)) {
                    isViolation = true;
                } else if (currentCounts[label] > allowedRules[label]) {
                    isViolation = true;
                }

                const color = isViolation ? "#EF4444" : "#22C55E"; // Red-500 or Green-500
                
                // Draw Box
                canvasCtx.beginPath();
                canvasCtx.lineWidth = 4;
                canvasCtx.strokeStyle = color;
                canvasCtx.rect(
                    detection.boundingBox.originX,
                    detection.boundingBox.originY,
                    detection.boundingBox.width,
                    detection.boundingBox.height
                );
                canvasCtx.stroke();

                // Draw Label Background
                canvasCtx.fillStyle = color;
                const text = `${label} ${Math.round(score * 100)}%`;
                const textWidth = canvasCtx.measureText(text).width;
                const textHeight = 20;

                canvasCtx.fillRect(
                    detection.boundingBox.originX,
                    detection.boundingBox.originY - textHeight,
                    textWidth + 10,
                    textHeight
                );

                // Draw Label Text
                canvasCtx.fillStyle = "#ffffff";
                canvasCtx.font = "bold 14px Roboto";
                canvasCtx.fillText(
                    text,
                    detection.boundingBox.originX + 5,
                    detection.boundingBox.originY - 5
                );
            }
        }
    </script>
</body>
</html>